{% extends 'v1_0_0/backend/base.html' %}
{% block title %}{{title}} :: {{ current_user.store.store_name }}{% endblock %}
{% block headstyles %}
<!-- Morris Chart Css-->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/morrisjs/morris.css')}}" />
<!-- Colorpicker Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.css')}}" />
<!-- Multi Select Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/multi-select/css/multi-select.css')}}">
<!-- Bootstrap Spinner Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/jquery-spinner/css/bootstrap-spinner.css')}}">
<!-- Bootstrap Tagsinput Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css')}}">
<!-- Bootstrap Select Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-select/css/bootstrap-select.css')}}" />
<!-- noUISlider Css -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/nouislider/nouislider.min.css')}}" />
<!-- Select2 -->
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/select2/select2.css')}}" />
<link rel="stylesheet" href="{{url_for('static',filename='v1_0_0/backend/assets/plugins/sweetalert/sweetalert.css')}}" />

{% endblock %}

<!-- Main Content -->
{% block content %}
<section class="content">
	<div class="block-header">
		<div class="row">
			<div class="col-lg-7 col-md-6 col-sm-12">
				<h2>Dashboard</h2>
				<ul class="breadcrumb">
					<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}"><i class="zmdi zmdi-home"></i> Deogon</a></li>
					<li class="breadcrumb-item active">Dashboard</li>
				</ul>
				<button class="btn btn-primary btn-icon mobile_menu" type="button"><i class="zmdi zmdi-sort-amount-desc"></i></button>
			</div>
			<div class="col-lg-5 col-md-6 col-sm-12">
				<button class="btn btn-primary btn-icon float-right right_icon_toggle_btn" type="button"><i class="zmdi zmdi-arrow-right"></i></button>
			</div>
		</div>
	</div>
	<div class="container-fluid">
		<div class="row clearfix">
			<div class="col-lg-12 col-md-12 col-sm-12">
				<div class="card">
					<div class="header">
						<h2><strong>Sale</strong> Details</h2>
						<ul class="header-dropdown">
							<li class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
								<ul class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; transform: translate3d(-127px, 33px, 0px); top: 0px; left: 0px; will-change: transform;">
									<li><a href="javascript:void(0);">Report a problem</a></li>
								</ul>
							</li>
						</ul>
					</div>
					<div class="body">
                        <form action="/" id="sale_details" method="post">
                            {{ saleform.hidden_tag() }}
                            <div class="row clearfix">
                                {{ saleform.sale_id }}
                            </div>
                            <div class="row clearfix">
                                <div class="col-md-3">
                                    {{ saleform.customer.label }}
                                    <div class="form-group">
                                        {{ saleform.customer }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ saleform.care_of.label }}
                                    <div class="form-group">
                                        {{ saleform.care_of }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ saleform.salesman.label }}
                                    <div class="form-group">
                                        {{ saleform.salesman }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ saleform.cash_account.label }}
                                    <div class="form-group">
                                        {{ saleform.cash_account }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    {{ saleform.desc.label }}
                                    <div class="form-group">
                                        {{ saleform.desc }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ saleform.counter.label }}
                                    <div class="form-group">
                                        {{ saleform.counter }}
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    {{ saleform.goldrate.label }}
                                    <div class="form-group">
                                        {{ saleform.goldrate }}
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    {{ saleform.total.label }}
                                    <div class="form-group">
                                        {{ saleform.total }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    {{ saleform.balance.label }}
                                    <div class="form-group">
                                        {{ saleform.balance }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    {{ saleform.discount.label }}
                                    <div class="form-group">
                                        {{ saleform.discount }}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    {{ saleform.grand.label }}
                                    <div class="form-group">
                                        {{ saleform.grand }}
                                    </div>
                                </div>
                            </div>
                        </form>
					</div>
				</div>
			</div>
		</div>
		<div class="row clearfix">
			<div class="col-lg-8 col-md-8 col-sm-8">
				<div class="card">
					<div class="header">
						<h2><strong>Product</strong> Details</h2>
						<ul class="header-dropdown">
							<li class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
								<ul class="dropdown-menu dropdown-menu-right">
									<li><a href="javascript:void(0);">Action</a></li>
									<li><a href="javascript:void(0);">Another action</a></li>
									<li><a href="javascript:void(0);">Something else</a></li>
								</ul>
							</li>
							<li class="remove">
								<a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
							</li>
						</ul>
					</div>
					<div class="body">
						<form action="/" id="form_product" method="post">
							{{ pform.product_id }}
							<div class="row clearfix">
								<div class="col-md-4">
									{{ pform.category.label }}
									<div class="form-group">
										{{ pform.category }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.carat.label }}
									<div class="form-group">
										{{ pform.carat }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.metal.label }}
									<div class="form-group">
										{{ pform.metal }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.supplier.label }}
									<div class="form-group">
										{{ pform.supplier }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.design_no.label }}
									<div class="form-group">
										{{ pform.design_no }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.size.label }}
									<div class="form-group">
										{{ pform.size }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.qty.label }}
									<div class="form-group">
										{{ pform.qty }}
									</div>
								</div>
								<div class="col-md-8">
									{{ pform.desc.label }}
									<div class="form-group">
										{{ pform.desc }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.product_code.label }}
									<div class="form-group">
										{{ pform.product_code }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.ratti_method.label }}
									<div class="form-group">
										{{ pform.ratti_method }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.operator.label }}
									<div class="form-group">
										{{ pform.operator }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.weight.label }}
									<div class="form-group">
										{{ pform.weight }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.waste.label }}
									<div class="form-group">
										{{ pform.waste }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.ratti.label }}
									<div class="form-group">
										{{ pform.ratti }}
									</div>
								</div>

							</div>
							<div class="row clearfix">
								<div class="col-md-4">
									{{ pform.net.label }}
									<div class="form-group">
										{{ pform.net }}
									</div>
								</div>
								<div class="col-md-4">
									{{ pform.gross.label }}
									<div class="form-group">
										{{ pform.gross }}
									</div>
								</div>
							</div>
							<div class="row clearfix">
								<div class="col-md-4">
									<div class="form-group form-float">
										<div class="checkbox">
											{{ pform.is_order }}
											{{ pform.is_order.label }}
										</div>
									</div>
								</div>
							</div>
							<div class="row clearfix">
								<div class="col-md-4">
									<div class="form-group form-float">
										<div class="checkbox">
											{{ pform.is_split}}
											{{ pform.is_split.label }}
										</div>
									</div>
								</div>
							</div>
							<div class="row clearfix">
								<div class="col-md-4">
									{{ pform.split_weight.label }}
									<div class="form-group">
										{{ pform.split_weight }}
									</div>
								</div>
							</div>

							<div class="col-md-4">
								{{ pform.addbtn }}
							</div>
						</form>
					</div>
				</div>
			</div>
			<div class="col-lg-4 col-md-4 col-sm-4">
				<div class="card">
					<div class="header">
						<h2><strong>Search</strong> Product</h2>
						<ul class="header-dropdown">
							<li class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
								<ul class="dropdown-menu dropdown-menu-right">
									<li><a href="javascript:void(0);">Action</a></li>
									<li><a href="javascript:void(0);">Another action</a></li>
									<li><a href="javascript:void(0);">Something else</a></li>
								</ul>
							</li>
							<li class="remove">
								<a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
							</li>
						</ul>
					</div>
					<div class="body">
						<form id="form_search" method="POST">

							<div class="row clearfix">
								<div class="col-lg-8 col-md-8 col-sm-8">
									<div class="form-group">
										{{ sform.code_input }}
									</div>
								</div>
								<div class="col-lg-4 col-md-4 col-sm-4">
									{{ sform.searchbtn }}
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="card" id="sale_point">
					<div class="header">
						<h2><strong>Sales</strong> Point</h2>
						<ul class="header-dropdown">
							<li class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
								<ul class="dropdown-menu dropdown-menu-right">
									<li><a href="javascript:void(0);">Action</a></li>
									<li><a href="javascript:void(0);">Another action</a></li>
									<li><a href="javascript:void(0);">Something else</a></li>
								</ul>
							</li>
							<li class="remove">
								<a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
							</li>
						</ul>
					</div>
					<div class="body">
						<form id="form_sale" action="{{ url_for('admin.add_sale') }}" method="POST">
							{{ saleform.hidden_tag() }}
							<div class="row clearfix">
								<div id="items">

								</div>
								<div class="col-lg-4 col-md-4 col-sm-4">
									{{ saleform.savebtn }}
								</div>
							</div>
						</form>
					</div>
				</div>
				<div class="card" id="sale_update">
					<div class="header">
						<h2><strong>Sales</strong> Point</h2>
						<ul class="header-dropdown">
							<li class="dropdown">
								<a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> <i class="zmdi zmdi-more"></i> </a>
								<ul class="dropdown-menu dropdown-menu-right">
									<li><a href="javascript:void(0);">Action</a></li>
									<li><a href="javascript:void(0);">Another action</a></li>
									<li><a href="javascript:void(0);">Something else</a></li>
								</ul>
							</li>
							<li class="remove">
								<a role="button" class="boxs-close"><i class="zmdi zmdi-close"></i></a>
							</li>
						</ul>
					</div>
					<div class="body">
						<button class="btn btn-primary" id="btn_update">Primary</button>
						<button class="btn btn-warning" id="btn_return">Return</button>
						<button class="btn btn-danger" id="btn_delete">Danger</button>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
{% endblock content %}

{% block bodyScriptsA %}
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/jquery-validation/jquery.validate.js')}}"></script> <!-- Jquery Validation Plugin Css -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/jquery-steps/jquery.steps.js')}}"></script> <!-- JQuery Steps Plugin Js -->

<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-colorpicker/js/bootstrap-colorpicker.js')}}"></script> <!-- Bootstrap Colorpicker Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/jquery-inputmask/jquery.inputmask.bundle.js')}}"></script> <!-- Input Mask Plugin Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/multi-select/js/jquery.multi-select.js')}}"></script> <!-- Multi Select Plugin Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/jquery-spinner/js/jquery.spinner.js')}}"></script> <!-- Jquery Spinner Plugin Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-tagsinput/bootstrap-tagsinput.js')}}"></script> <!-- Bootstrap Tags Input Plugin Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/nouislider/nouislider.js')}}"></script> <!-- noUISlider Plugin Js -->
<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/bootstrap-notify/bootstrap-notify.js')}}"></script> <!-- Bootstrap Notify Plugin Js -->

<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/select2/select2.min.js')}}"></script> <!-- Select2 Js -->
{% endblock %}
{% block bodyScriptsB %}
<script src="{{url_for('static',filename='v1_0_0/backend/assets/js/pages/ui/notifications.js')}}"></script>
<script src="{{url_for('static',filename='v1_0_0/backend/assets/js/pages/forms/form-validation.js')}}"></script>

<script src="{{url_for('static',filename='v1_0_0/backend/assets/plugins/sweetalert/sweetalert.min.js')}}"></script> <!-- SweetAlert Plugin Js -->
<!--<script src="{{url_for('static',filename='v1_0_0/backend/assets/js/pages/ui/sweetalert.js')}}"></script>-->

<script type="text/javascript">
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
	function returnSale() {
		let sale_id = $('#sale_id').val()
        let data = JSON.stringify({ 'sale_id': sale_id })
        fetch("{{ url_for('admin.sale_return', _external=True) }}", {
            credentials: 'include',
            method: 'POST',
            headers: {
                'content-Type': 'application/json'
            },
            body: data
        })
            .then(resp => Promise.all([resp.ok, resp.json()]))
            .then(([status, data]) => {
				if (status) {
                    swal(data['msg'], {
                        icon: "success",
                    });
                    sleep(2000)
                        .then(() => {
                            location.replace("{{ url_for('admin.view_sales', _external = True) }}")
                            console.log("Redirecting")
                        })
                } else {
                    showNotification('alert-danger', data['msg'], 'top', 'right', null, null)
                }
            })
            .catch(e => invalidDataNotification())
	}
    function updateSale() {
        console.log('Sale updated')
	}
	function handleRequest(f) {
		return f()
    }
    function confirmWarning(f, title, msg, danger) {
        swal({
            title: title,
            text: msg,
            icon: "warning",
            buttons: true,
            dangerMode: danger,
        })
            .then((willDelete) => {
                if (willDelete) {
					handleRequest(f)
                } else {
                    swal("The opration was canceled!");
                }
            });
	}
	$('#btn_return').click(function (e) {
        confirmWarning(f = returnSale, title = "Are you sure?", msg = "Once returned, you will not be able to recover this sale!", danger = true)
	})
    $('#btn_update').click(function (e) {
        confirmWarning(f = updateSale, title = "Are you sure?", msg = "You are about to update this sale!", danger = false)
    })
	function invalidDataNotification(){
	  showNotification('alert-danger','Cannot connect to server. Please make sure you are connected to internet or contact your Administrator', 'top','right',null,null)
	}
	function check_visibility() {
		if (!$("#sale_point").is(":visible") && $("#sale_point").has("#item-1")) {
			$("#sale_point").show("fast")
		} else if ($("#sale_point").is(":visible") && !$("#sale_point").has("#item-1")) {
			$("#sale_point").hide("fast")
		}
	}
	check_visibility()
	$('#form_search').submit(function (e){
	  e.preventDefault()
		var form = $('#form_search')[0]
		var data = new FormData(form)
	  fetch("{{ url_for('admin.add_sale', _external=True) }}",{
		credentials: 'include',
		method : 'POST',
		body: data
	  })
	  .then(resp => Promise.all([resp.ok, resp.json()]))
	  .then(([status,data]) => {
		if (status) {
			$('#category').val(data['category'])
			$('#carat').val(data['carat'])
			$('#metal').val(data['metal'])
			$('#supplier').val(data['supplier'])
			$('#operator').val(data['operator'])
			$('#ratti_method').val(data['ratti_method'])
			$('#design_no').val(data['design_no'])
			$('#size').val(data['size'])
			$('#qty').val(data['qty'])
			$('#product_code').val(data['product_code'])
			$('#weight').val(data['weight'])
			$('#waste').val(data['waste'])
			$('#ratti').val(data['ratti'])
			$('#desc').val(data['desc'])
			$('#product_id').val(data['product_id'])
			var weight = parseFloat(data['weight'])
			var rate = parseFloat($('#goldrate').val())
			var net = weight*rate
			$('#net, #gross').val(net.toFixed(0))
			showNotification('alert-success',data['product_code'], 'top','right',null,null)
		} else {
		  showNotification('alert-danger',data['message'], 'top','right',null,null)
		}
	  })
	  .catch(e => invalidDataNotification())
	})
	var counter = 0
    $('#item-details').hide()
    function addProductValues() {
        var _parent = $('#items')
        var _div1 = {
            id: "item-" + counter,
            class: "col-lg-12 col-md-12 col-sm-12"
        }
        var _div2 = {
            class: "form-group"
        };
        var _input1 = {
            class: "form-control",
            value: $('#product_code').val(),
            readonly: true
        };
        var $div1 = $("<div>", _div1);
        $div = $div1.append($("<div>", _div2).append($("<input>", _input1)));
		_parent.append($div);
        var _parent_items = $('#item-details')
		var _id = $('#product_id').val()
        var is_split = $('#is_split').prop("checked")
		var is_order = $('#is_order').prop("checked")
		var net = $('#net').val()
		var gross = $('#gross').val()
		var weight = $('#split_weight').val()
        var _main_div = {
			id: "item-details-" + counter
        }
        var _product_id = {
            class: "form-control",
            type: "text",
            id: "product_details-" + counter + "-product_id",
            name: "product_details-" + counter + "-product_id",
            value: _id
		};
        var _net = {
            class: "form-control",
            type: "text",
            id: "product_details-" + counter + "-net",
            name: "product_details-" + counter + "-net",
            value: net
		};
        var _gross = {
            class: "form-control",
            type: "text",
            id: "product_details-" + counter + "-gross",
            name: "product_details-" + counter + "-gross",
            value: gross
        };
        var _is_split = {
            class: "form-control",
            type: "checkbox",
            id: "product_details-" + counter + "-is_split",
            name: "product_details-" + counter + "-is_split",
            checked: is_split
        };
        var _weight = {
            class: "form-control",
            type: "text",
            id: "product_details-" + counter + "-weight",
            name: "product_details-" + counter + "-weight",
            value: weight
        };
        var _is_order = {
            class: "form-control",
            type: "checkbox",
            id: "product_details-" + counter + "-is_order",
            name: "product_details-" + counter + "-is_order",
            checked: is_order
		};
		$main_div = $("<div>",_main_div)
        $items = $main_div.append($("<input>", _product_id)).append($("<input>", _net)).append($("<input>", _is_split)).append($("<input>", _gross)).append($("<input>", _is_order)).append($("<input>", _weight))
		_parent_items.append($items)
        showNotification('alert-success', 'Added ' + counter, 'top', 'right', null, null)
        // $div = $div1.append($("<div>", _div2).append($("<input>", _input1)).append($("<input>", _input2)).append($("<a>", _a).attr("data-name","item1")));
        counter++
    }
	$('#form_product').submit(function (e) {
		e.preventDefault()


		var gross = $('#gross').val()
		var net = $('#net').val()
		var total_amount = parseInt($('#total').val(),0)
		var grand_amount = parseInt($('#grand').val(), 0)
		if (total_amount !== NaN) {
			$('#total').val(parseInt(total_amount) + parseInt(net))
		} else {
            $('#total').val(parseInt(net))
		}
        if (grand_amount !== NaN) {
            $('#grand').val(parseInt(grand_amount) + parseInt(gross))
        } else {
            $('#grand').val(parseInt(gross))
        }
        addProductValues()

	})
    $('#form_sale').submit(function (e) {
        e.preventDefault()
        var form = $('#sale_details')[0]
        var data = new FormData(form)
        fetch("{{ url_for('admin.add_sale', _external=True) }}", {
            credentials: 'include',
            method: 'POST',
            body: data
        })
            .then(resp => Promise.all([resp.ok, resp.json()]))
            .then(([status, data]) => {
                if (status) {

                    showNotification('alert-success',data['msg'], 'top', 'right', null, null)
                } else {
                    showNotification('alert-danger', data['msg'], 'top', 'right', null, null)
                }
            })
            .catch(e => invalidDataNotification())
    })
</script>
{% endblock %}
