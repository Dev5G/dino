$('#confirmDialogue').on('show.bs.modal', function(event) {
    var button = $(event.relatedTarget) // Button that triggered the modal
    var cid = button.data('integeration') // Extract info from data-* attributes
    // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
    // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
    var modal = $(this)
    //modal.find('.modal-title').text('New message to ' + recipient)
    //modal.find('.modal-body input').val(recipient)
    modal.find('#delete_form').attr("action","{{ url_for('admin.gold_rate') }}?id=" + cid + "&method=delete")
})
function invalidDataToast(){
  toastr['error']('Cannot connect to server. Please make sure you are connected to internet', 'Invalid request')
}
//var table = $('#category_table').DataTable()
//$('#category_table tbody').on('click','tr', function(){ console.log(table.row(this).data())})
let _ctx = ''
function cl_rt(){
  let weight = parseFloat($('#weight').val())
  let ratti = parseFloat($('#ratti').val())
  if (weight !== 0 && weight && ratti !== 0 && ratti) {
     if ($('#ratti_method').val()) {
       let v = eval(_ctx)
      $('#pure_weight').val(v.toFixed(3))
    } else {
      toastr['error']('Please select a ratti method first.', 'Error')
      }
    }
}
function cl_tw(){
  var weight = parseFloat($('#weight').val())
  var waste = parseFloat($('#waste').val())
  if (weight !== 0 && weight) {
     if (waste !== 0 && waste) {
       let gm_weight = (weight * waste / 100)
       let t_w = gm_weight + weight
       if (t_w) {
         $('#total_weight').val(t_w.toFixed(3))
       }
       if (gm_weight) {
         $('#gm_weight').text('Gm waste: ' + gm_weight.toFixed(3))
       } else {
         $('#gm_weight').text('')
       }
     } else {
      $('#total_weight').val(weight.toFixed(3))

     }
  }
}
$('#weight,#ratti').keyup(function (e) {
  try {
    cl_rt()
  } catch (e) {
    console.log(e)
  }
})
$('#weight,#waste').keyup(function(e){
  try {
    cl_tw()
  } catch (e) {
    console.log(e)
  }
})
$('#category').change(function (e){
  var v = e.currentTarget.value
  ///////////////
      // toastr.options = {
      //     closeButton: true,
      //     debug: true,
      //     newestOnTop: true,
      //     progressBar: false,
      //     rtl: false,
      //     positionClass: 'toast-top-right',
      //     preventDuplicates: true,
      //     onclick: null,
      //     showDuration : 300,
      //     hideDuration : 1000,
      //     timeOut : 5000,
      //     extendedTimeOut : 1000,
      //     showEasing : 'swing',
      //     hideEasing : 'linear',
      //     showMethod : 'fadeIn',
      //     hideMethod : 'fadeOut'
      // };

    //  var $toast = toastr[shortCutFunction](msg, title); // Wire up an event handler to a button in the toast, if it exists
  ///////////////
  if (!$('#category').val()) {
    return;
  }
  fetch('{{ url_for('admin.get_code', _external=True) }}',{
    credentials : 'include',
    method : 'POST',
    headers : {
      'content-Type': 'application/json'
    },
    body: JSON.stringify({'cat_id': v})
  })
  .then(resp => Promise.all([resp.ok ,resp.json()]))
  .then(([status, data]) => {
    if (status) {
      $('#product_code').val(data['code'])
    }else {
       toastr['error'](data['message'], 'Error')
    }
  })
  .catch(e => invalidDataToast())
})
$('#ratti_method').change(function (e){
  var v = e.currentTarget.value
  fetch('{{ url_for('admin.get_formula', _external=True) }}',{
    credentials: 'include',
    method : 'POST',
    headers: {
      'content-Type': 'application/json'
    }, // headers
    body: JSON.stringify({'method_id': v})
  })
  .then(resp => Promise.all([resp.ok, resp.json()]))
  .then(([status,data]) => {
    if (status) {
    _ctx = (data['formula'])
      cl_rt()
    } else {
      toastr['error'](data['message'], 'Error')
    }
  })
  .catch(e => invalidDataToast())
})
$('#product-form').submit(function (e){
  e.preventDefault()
  let form = $('#product-form')[0]
  let data = new FormData(form)
  fetch('{{ url_for('admin.products', _external=True) }}',{
    credentials: 'include',
    method : 'POST',
    body: data
  })
  .then(resp => Promise.all([resp.ok, resp.json()]))
  .then(([status,data]) => {
    if (status) {
    toastr['success'](data['message'], 'Error')
    $('#weight').focus()
    } else {
      toastr['error'](data['message'], 'Error')
    }
  })
  .catch(e => invalidDataToast())
})
toastr.clear()
